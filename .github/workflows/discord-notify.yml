name: Discord notifications

on:
  push:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened]
  watch:
    types: [started]   # Ð½Ð¾Ð²Ñ‹Ð¹ Ð·Ð²ÐµÐ·Ð´Ð¾Ñ‡Ð½Ñ‹Ð¹ "star"
  fork:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send embed to Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT=${{ github.event_name }}
          ACTOR=${{ github.actor }}
          REPO=${{ github.repository }}

          # ------ PUSH ------
          if [ "$EVENT" = "push" ]; then
            COMMITS=$(jq -r '[.commits[].message] | join("\n")' <<< '${{ toJson(github.event) }}')
            BRANCH=${{ github.ref_name }}
            COLOR=3066993

            PAYLOAD=$(jq -n \
              --arg title "ÐÐ¾Ð²Ñ‹Ð¹ push" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg branch "$BRANCH" \
              --arg commits "$COMMITS" \
              --argjson color $COLOR \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo, inline: true},
                    {name: "ÐÐ²Ñ‚Ð¾Ñ€", value: $actor, inline: true},
                    {name: "Ð’ÐµÑ‚ÐºÐ°", value: $branch, inline: true},
                    {name: "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹", value: $commits}
                  ]
                }]
              }'
            )
          fi

          # ------ ISSUES ------
          if [ "$EVENT" = "issues" ]; then
            ACTION=${{ github.event.action }}
            TITLE=${{ github.event.issue.title }}
            URL=${{ github.event.issue.html_url }}
            COLOR=3447003

            PAYLOAD=$(jq -n \
              --arg title "Issue: $ACTION" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg issue "$TITLE" \
              --arg url "$URL" \
              --argjson color $COLOR \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo},
                    {name: "ÐÐ²Ñ‚Ð¾Ñ€", value: $actor},
                    {name: "Issue", value: $issue}
                  ]
                }]
              }'
            )
          fi

          # ------ PULL REQUESTS ------
          if [ "$EVENT" = "pull_request" ]; then
            ACTION=${{ github.event.action }}
            TITLE=${{ github.event.pull_request.title }}
            URL=${{ github.event.pull_request.html_url }}
            COLOR=15105570

            PAYLOAD=$(jq -n \
              --arg title "Pull request: $ACTION" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg pr "$TITLE" \
              --arg url "$URL" \
              --argjson color $COLOR \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo},
                    {name: "ÐÐ²Ñ‚Ð¾Ñ€", value: $actor},
                    {name: "Pull Request", value: $pr}
                  ]
                }]
              }'
            )
          fi

          # ------ NEW STAR ------
          if [ "$EVENT" = "watch" ]; then
            COLOR=16776960

            PAYLOAD=$(jq -n \
              --arg title "ÐÐ¾Ð²Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð° â­" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --argjson color $COLOR \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo},
                    {name: "Ð”Ð¾Ð±Ð°Ð²Ð¸Ð» Ð·Ð²ÐµÐ·Ð´Ñƒ", value: $actor}
                  ]
                }]
              }'
            )
          fi

          # ------ NEW FORK ------
          if [ "$EVENT" = "fork" ]; then
            COLOR=12370112

            PAYLOAD=$(jq -n \
              --arg title "ÐÐ¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ðº ðŸ´" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --argjson color $COLOR \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo},
                    {name: "Ð¡Ð´ÐµÐ»Ð°Ð» Ñ„Ð¾Ñ€Ðº", value: $actor}
                  ]
                }]
              }'
            )
          fi

          # ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ°
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL"
