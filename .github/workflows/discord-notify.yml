name: Discord notifications (embed)

on:
  push:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, labeled, unlabeled, synchronize]
  watch:
    types: [started]     # star
  fork:
    types: [created]
  release:
    types: [published]
  workflow_dispatch:    # Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare environment
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          EVENT_JSON: '${{ toJson(github.event) }}'
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "WEBHOOK_URL is empty. Set secret DISCORD_WEBHOOK."
            exit 1
          fi

          # helper: escape for jq
          EVENT_NAME_ESC=$(jq -Rn --arg in "$EVENT_NAME" '$in')
          REPO_ESC=$(jq -Rn --arg in "$REPO" '$in')
          ACTOR_ESC=$(jq -Rn --arg in "$ACTOR" '$in')

          # default payload (fallback)
          PAYLOAD=$(jq -n --arg title "GitHub: $REPO" --arg desc "Event: $EVENT_NAME" --arg actor "$ACTOR" '{
            embeds: [{ title: $title, description: $desc, color: 3447003, fields: [{name:"Actor", value:$actor}]}]
          }')

          # PUSH
          if [ "$EVENT_NAME" = "push" ]; then
            BRANCH=${{ github.ref_name }}
            COMMITS=$(echo "$EVENT_JSON" | jq -r '[.commits[] | ("â€¢ [" + (.id|.[:7]) + "](" + .url + ") " + ( .message | split("\n")[0] ) + " â€” " + (.author.name // .author.email) )] | join("\n")')
            SHORT_COMMITS=$(echo "$COMMITS" | head -c 1500)
            COMPARE=$(echo "$EVENT_JSON" | jq -r .compare)
            PAYLOAD=$(jq -n \
              --arg title "Push to $BRANCH" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg commits "$SHORT_COMMITS" \
              --arg compare "$COMPARE" \
              --argjson color 3066993 \
              '{
                embeds: [{
                  title: $title,
                  url: $compare,
                  color: $color,
                  fields: [
                    {name: "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value: $repo, inline: true},
                    {name: "ÐÐ²Ñ‚Ð¾Ñ€", value: $actor, inline: true},
                    {name: "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹", value: ($commits // "ÐÐµÑ‚ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²")}
                  ]
                }]
              }'
            )
          fi

          # ISSUES
          if [ "$EVENT_NAME" = "issues" ]; then
            ACTION=$(echo "$EVENT_JSON" | jq -r .action)
            TITLE=$(echo "$EVENT_JSON" | jq -r .issue.title)
            URL=$(echo "$EVENT_JSON" | jq -r .issue.html_url)
            BODY=$(echo "$EVENT_JSON" | jq -r .issue.body | sed 's/"/\\"/g' | head -c 1500)
            PAYLOAD=$(jq -n \
              --arg title "Issue: ${ACTION^}" \
              --arg url "$URL" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg issue "$TITLE" \
              --arg body "$BODY" \
              --argjson color 3447003 \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name:"Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value:$repo, inline:true},
                    {name:"ÐÐ²Ñ‚Ð¾Ñ€", value:$actor, inline:true},
                    {name:"Issue", value:$issue},
                    {name:"Body (preview)", value:($body|if .=="" then "â€”" else . end)}
                  ]
                }]
              }'
            )
          fi

          # PULL REQUEST
          if [ "$EVENT_NAME" = "pull_request" ]; then
            ACTION=$(echo "$EVENT_JSON" | jq -r .action)
            TITLE=$(echo "$EVENT_JSON" | jq -r .pull_request.title)
            URL=$(echo "$EVENT_JSON" | jq -r .pull_request.html_url)
            PR_NUM=$(echo "$EVENT_JSON" | jq -r .number)
            PAYLOAD=$(jq -n \
              --arg title "Pull Request: ${ACTION^}" \
              --arg url "$URL" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg pr "$TITLE" \
              --arg prnum "$PR_NUM" \
              --argjson color 15105570 \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name:"Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value:$repo, inline:true},
                    {name:"ÐÐ²Ñ‚Ð¾Ñ€", value:$actor, inline:true},
                    {name:"PR", value:("#" + $prnum + " â€” " + $pr)}
                  ]
                }]
              }'
            )
          fi

          # WATCH (star)
          if [ "$EVENT_NAME" = "watch" ]; then
            PAYLOAD=$(jq -n \
              --arg title "ÐÐ¾Ð²Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð° â­" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --argjson color 16776960 \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    {name:"Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value:$repo},
                    {name:"ÐŸÐ¾ÑÑ‚Ð°Ð²Ð¸Ð»(Ð°) Ð·Ð²ÐµÐ·Ð´Ñƒ", value:$actor}
                  ]
                }]
              }'
            )
          fi

          # FORK
          if [ "$EVENT_NAME" = "fork" ]; then
            FORK_OWNER=$(echo "$EVENT_JSON" | jq -r .forkee.owner.login)
            FORK_URL=$(echo "$EVENT_JSON" | jq -r .forkee.html_url)
            PAYLOAD=$(jq -n \
              --arg title "ÐÐ¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ðº ðŸ´" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg forker "$FORK_OWNER" \
              --arg url "$FORK_URL" \
              --argjson color 12370112 \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name:"Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value:$repo},
                    {name:"ÐšÑ‚Ð¾ ÑÐ´ÐµÐ»Ð°Ð» Ñ„Ð¾Ñ€Ðº", value:$forker}
                  ]
                }]
              }'
            )
          fi

          # RELEASE
          if [ "$EVENT_NAME" = "release" ]; then
            ACTION=$(echo "$EVENT_JSON" | jq -r .action)
            TAG=$(echo "$EVENT_JSON" | jq -r .release.tag_name)
            URL=$(echo "$EVENT_JSON" | jq -r .release.html_url)
            BODY=$(echo "$EVENT_JSON" | jq -r .release.body | head -c 1500)
            PAYLOAD=$(jq -n \
              --arg title "New Release: $TAG" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg url "$URL" \
              --arg body "$BODY" \
              --argjson color 3066993 \
              '{
                embeds: [{
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {name:"Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", value:$repo},
                    {name:"ÐÐ²Ñ‚Ð¾Ñ€", value:$actor},
                    {name:"ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ (preview)", value:($body|if .=="" then "â€”" else . end)}
                  ]
                }]
              }'
            )
          fi

          # Final: send to Discord
          echo "Sending payload to Discord..."
          echo "$PAYLOAD" | jq -c . > /tmp/gh_payload.json
          cat /tmp/gh_payload.json

          curl -s -H "Content-Type: application/json" \
            -X POST \
            --data-binary @/tmp/gh_payload.json \
            "$WEBHOOK_URL"
